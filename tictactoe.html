<!DOCTYPE html>
<html>
    <head>
		<title>SuperTicTacToe XOX</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="style.css">
        <style>
            button {
                aspect-ratio: 1;
                background: none;
                color: white;
                border: 1px solid white;
                font-size: 6vmin;
                font-family: sans-serif;
                font-weight: bold;
            }
            button:hover {
                background: #FFF3;
            }
            button:active {
                background: #FFF6;
            }
            .mini-board {
                border: 3px solid white;
                border-radius: 10px; 
                background: #624;
                display: grid;
                grid-template-columns: 33.33% 33.33% 33.33%;
                aspect-ratio: 1;
                width: 25vmin;
                margin: auto;
            }
            svg {
                grid-column: 1/-1;
                grid-row: 1/-1;
                pointer-events: none;
            }
        </style>
        <script type="module">
            function do_move_callback(x, y, i, j, score) {
                console.log(`score: ${score}, place at ${x+1}${y+1}_${i+1}${j+1}`);
                c({target: document.getElementById(`${x+1}${y+1}_${i+1}${j+1}`)});
            }
            var agent_do_move = () => {};
            var player = 'X';
            var ended = false;
            var miniboards = [["", "", ""], ["", "", ""], ["", "", ""]];
            var allowed = null;
            WebAssembly.instantiateStreaming(fetch("supertictactoe.wasm"), { env: {do_move_callback: do_move_callback} }).then(
                (obj) => agent_do_move = obj.instance.exports.do_move
            );
            function show_end_mini(x, y, x1, y1, x2, y2) {
                let line = document.getElementById(`l${x}${y}`);
                line.setAttribute("x1", x1);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                line.setAttribute("visibility", "visible");
                miniboards[x-1][y-1] = player;
            }
            function show_end(x1, y1, x2, y2) {
                let line = document.getElementById(`l`);
                line.setAttribute("x1", x1);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x2);
                line.setAttribute("y2", y2);
                line.setAttribute("visibility", "visible");
                ended = true;
                document.getElementById("title").textContent = `${player} wins`;
            }
            function check_end_mini() {
                for (let x = 1; x <= 3; x++) {
                    for (let y = 1; y <= 3; y++) {
                        if (miniboards[x-1][y-1] != "") {
                            continue;
                        }
                        let d1 = '';
                        let d2 = '';
                        for (let i = 1; i <= 3; i++) {
                            // horizontals/verticals
                            let h = '';
                            let v = '';
                            for (let j = 1; j <= 3; j++) {
                                h += document.getElementById(`${x}${y}_${j}${i}`).textContent;
                                v += document.getElementById(`${x}${y}_${i}${j}`).textContent;
                            }
                            if (h == player.repeat(3)) {
                                show_end_mini(x, y, i*2-1, 1, i*2-1, 5);
                                return;
                            }
                            if (v == player.repeat(3)) {
                                show_end_mini(x, y, 1, i*2-1, 5, i*2-1);
                                return;
                            }
                            // diagonals
                            d1 += document.getElementById(`${x}${y}_${i}${i}`).textContent;
                            d2 += document.getElementById(`${x}${y}_${i}${4-i}`).textContent;
                        }
                        if (d1 == player.repeat(3)) {
                            show_end_mini(x, y, 1, 1, 5, 5);
                        }
                        else if (d2 == player.repeat(3)) {
                            show_end_mini(x, y, 1, 5, 5, 1);
                        }
                    }
                }
            }
            function check_end() {
                let d1 = '';
                let d2 = '';
                for (let i = 1; i <= 3; i++) {
                    // horizontals/verticals
                    let h = '';
                    let v = '';
                    for (let j = 1; j <= 3; j++) {
                        h += miniboards[i-1][j-1];
                        v += miniboards[j-1][i-1];
                    }
                    if (h == player.repeat(3)) {
                        show_end(1, i*2-1, 5, i*2-1);
                        return;
                    }
                    if (v == player.repeat(3)) {
                        show_end(i*2-1, 1, i*2-1, 5);
                        return;
                    }
                    // diagonals
                    d1 += miniboards[i-1][i-1];
                    d2 += miniboards[i-1][3-i];
                }
                if (d1 == player.repeat(3)) {
                    show_end(1, 1, 5, 5);
                }
                else if (d2 == player.repeat(3)) {
                    show_end(1, 5, 5, 1);
                }
            }
            function c(e) {
                if (!ended && e.target.textContent == '') {
                    let pos_xy = [Number(e.target.id[0]), Number(e.target.id[1])];
                    let pos_ij = [Number(e.target.id[3]), Number(e.target.id[4])];
                    if (allowed != null && (pos_xy[0] != allowed[0] || pos_xy[1] != allowed[1])) {
                        console.log("not allowed move");
                        return;
                    }
                    e.target.textContent = player;
                    check_end_mini();
                    check_end();
                    if (!ended) {
                        player = player!='X'?'X':'O';
                        function update_highlight() {
                            for (let x = 1; x <= 3; x++) {
                                for (let y = 1; y <= 3; y++) {
                                    document.getElementById(`d${x}${y}`).style.backgroundColor = "#624";
                                }
                            }

                            allowed = pos_ij;
                            document.getElementById(`d${allowed[0]}${allowed[1]}`).style.backgroundColor = "#426";
                            // check if the allowed pos is full. In that case switch to allowing all again
                            for (let i = 1; i <= 3; i++) {
                                for (let j = 1; j <= 3; j++) {
                                    let btn = document.getElementById(`${allowed[0]}${allowed[1]}_${i}${j}`);
                                    if (btn.textContent == "") {
                                        return;
                                    }
                                }
                            }
                            for (let x = 1; x <= 3; x++) {
                                for (let y = 1; y <= 3; y++) {
                                    document.getElementById(`d${x}${y}`).style.backgroundColor = "#426";
                                }
                            }
                            allowed = null;
                        }
                        update_highlight();
                        if (player == 'O') {
                            agent_do_move(pos_xy[0]-1, pos_xy[1]-1, pos_ij[0]-1, pos_ij[1]-1);
                            return;
                        }
                    }
                }
                else {
                    if (ended) {
                        window.location.reload();
                    }
                    console.log("clicked occupied at", e.target.id);
                }
            }
            document.addEventListener("DOMContentLoaded", (e) => {
                for (let btn of document.getElementsByTagName("button")) {
                    btn.onclick = c;
                }
            });
        </script>
    </head>
    <body>
        <main>
            <h1 id="title" style="text-align: center; font-family: sans-serif; font-size: 7.5vmin; margin-top: 0px; color: white;">Super Tic-Tac-Toe</h1>
            <div class="mini-board" style="width: 77vmin;">
            <div id="d11" class="mini-board">
                <button id="11_11"></button><button id="11_12"></button><button id="11_13"></button>
                <button id="11_21"></button><button id="11_22"></button><button id="11_23"></button>
                <button id="11_31"></button><button id="11_32"></button><button id="11_33"></button>
                <svg id="s11" viewBox="0 0 6 6"><line id="l11" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d12" class="mini-board">
                <button id="12_11"></button><button id="12_12"></button><button id="12_13"></button>
                <button id="12_21"></button><button id="12_22"></button><button id="12_23"></button>
                <button id="12_31"></button><button id="12_32"></button><button id="12_33"></button>
                <svg id="s12" viewBox="0 0 6 6"><line id="l12" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d13" class="mini-board">
                <button id="13_11"></button><button id="13_12"></button><button id="13_13"></button>
                <button id="13_21"></button><button id="13_22"></button><button id="13_23"></button>
                <button id="13_31"></button><button id="13_32"></button><button id="13_33"></button>
                <svg id="s13" viewBox="0 0 6 6"><line id="l13" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>

            <div id="d21" class="mini-board">
                <button id="21_11"></button><button id="21_12"></button><button id="21_13"></button>
                <button id="21_21"></button><button id="21_22"></button><button id="21_23"></button>
                <button id="21_31"></button><button id="21_32"></button><button id="21_33"></button>
                <svg id="s21" viewBox="0 0 6 6"><line id="l21" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d22" class="mini-board">
                <button id="22_11"></button><button id="22_12"></button><button id="22_13"></button>
                <button id="22_21"></button><button id="22_22"></button><button id="22_23"></button>
                <button id="22_31"></button><button id="22_32"></button><button id="22_33"></button>
                <svg id="s22" viewBox="0 0 6 6"><line id="l22" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d23" class="mini-board">
                <button id="23_11"></button><button id="23_12"></button><button id="23_13"></button>
                <button id="23_21"></button><button id="23_22"></button><button id="23_23"></button>
                <button id="23_31"></button><button id="23_32"></button><button id="23_33"></button>
                <svg id="s23" viewBox="0 0 6 6"><line id="l23" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>

            <div id="d31" class="mini-board">
                <button id="31_11"></button><button id="31_12"></button><button id="31_13"></button>
                <button id="31_21"></button><button id="31_22"></button><button id="31_23"></button>
                <button id="31_31"></button><button id="31_32"></button><button id="31_33"></button>
                <svg id="s31" viewBox="0 0 6 6"><line id="l31" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d32" class="mini-board">
                <button id="32_11"></button><button id="32_12"></button><button id="32_13"></button>
                <button id="32_21"></button><button id="32_22"></button><button id="32_23"></button>
                <button id="32_31"></button><button id="32_32"></button><button id="32_33"></button>
                <svg id="s32" viewBox="0 0 6 6"><line id="l32" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <div id="d33" class="mini-board">
                <button id="33_11"></button><button id="33_12"></button><button id="33_13"></button>
                <button id="33_21"></button><button id="33_22"></button><button id="33_23"></button>
                <button id="33_31"></button><button id="33_32"></button><button id="33_33"></button>
                <svg id="s33" viewBox="0 0 6 6"><line id="l33" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
            <svg id="s" viewBox="0 0 6 6"><line id="l" visibility="hidden" stroke-width="0.3" stroke="#F92" stroke-linecap="round"/></svg>
            </div>
        </main>
    </body>
</html>
